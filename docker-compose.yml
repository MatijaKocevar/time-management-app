version: "3.8"

services:
    app:
        build:
            context: .
            dockerfile: Dockerfile
        ports:
            - "3000:3000"
        environment:
            - NODE_ENV=development
            - DATABASE_URL=file:/app/database/dev.db
            - NEXTAUTH_SECRET=dev-secret-change-in-production
            - NEXTAUTH_URL=http://localhost:3000
        volumes:
            - ./database:/app/database
            - ./src:/app/src
            - ./prisma:/app/prisma
        depends_on:
            - db-init
        restart: unless-stopped

    db-init:
        build:
            context: .
            dockerfile: Dockerfile
        environment:
            - DATABASE_URL=file:/app/database/dev.db
        volumes:
            - ./database:/app/database
            - ./prisma:/app/prisma
        command: ["sh", "-c", "npx prisma migrate deploy && npx prisma db seed || true"]
        restart: "no"

volumes:
    database:
